<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset='utf-8'/>
    <title></title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no'/>
    <script src="https://cdn.bootcss.com/jquery/1.10.2/jquery.min.js"></script>
    <script src='//cdn.bootcss.com/mapbox-gl/0.39.1/mapbox-gl.js'></script>
    <link href='//cdn.bootcss.com/mapbox-gl/0.39.1/mapbox-gl.css' rel='stylesheet'/>
    <!--<script src='//cdn.bootcss.com/Turf.js/4.5.2/turf.js' charset='utf-8'></script>-->
    <script src='https://cdn.bootcss.com/Turf.js/5.1.6/turf.min.js'></script>
    <script src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
    <!--<script src="./map/storm.js"></script>       &lt;!&ndash;近海水文&ndash;&gt;-->
    <script src="./map/swan.js"></script>       <!--浪-->
    <script src="./map/swa.js"></script>       <!--浪-->
    <script src="./map/delaunay.js"></script>
    <style>
        .rangemenu{
            display: block;
            height: 300px;
            width:550px;
            top:20px;
            left:10%;
            margin-left:-100px;
            position: absolute;
        }
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }

        .btn-control {
            font: bold 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
            background-color: #3386c0;
            color: #fff;
            position: absolute;
            top: 20px;
            left: 40%;
            border: none;
            width: 200px;
            margin-left: -100px;
            display: block;
            cursor: pointer;
            padding: 10px 20px;
            border-radius: 3px;
        }

        .btn-control:hover {
            background-color: #4ea0da;
        }

        .btn-control1 {
            font: bold 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
            background-color: #3386c0;
            color: #fff;
            position: absolute;
            top: 20px;
            left: 50%;
            border: none;
            width: 200px;
            margin-left: -100px;
            display: block;
            cursor: pointer;
            padding: 10px 20px;
            border-radius: 3px;
        }

        .btn-control1:hover {
            background-color: #4ea0da;
        }
    </style>
</head>
<body>
<div id='map'></div>
<button id='original' class='btn-control'>原始</button>
<button id='delaunay' class='btn-control' style="left: 50%;">delaunay</button>
<button id='export' class='btn-control' style="left: 60%;">export</button>
<button id='import' class='btn-control' style="left: 70%;">import</button>
<button id='group' class='btn-control' style="left: 80%;">选块</button>
<div id="routeMain" class="rangemenu" >
    <textarea id="lonlatIndex"></textarea>
</div>
<script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiaGZiNTY0IiwiYSI6ImNqN2I3NnplMTBwb2IzMnJzcWh0OWp6YTQifQ.TM_EQumke3MvFzemeZE48g';
    let map = new mapboxgl.Map({
        container: 'map', // container id
        style: {
            "version": 8,
            "sprite": "mapbox://sprites/mapbox/bright-v8",
            "glyphs": "mapbox://fonts/mapbox/{fontstack}/{range}.pbf",
            "sources": {
                "raster-tiles": {
                    "type": "raster",
                    "tiles": ['http://mt0.google.cn/vt/v=w2.114&hl=zh-CN&gl=cn&x={x}&y={y}&z={z}'],     //谷歌地图地址
                    "tileSize": 256
                }
            },
            "layers": [{
                "id": "simple-tiles",
                "type": "raster",
                "source": "raster-tiles",
                "minzoom": 0,
                "maxzoom": 22
            }]
        },
        center: [0, 0], // starting position
        zoom: 1 // starting zoom
    });
    let geojson = {
        "type": "FeatureCollection",
        "features": []
    };

    let geojsonDelaunay = {
        "type": "FeatureCollection",
        "features": []
    };

    let group=false;

    map.on('load', function () {
        /*// $.getJSON("../src/map/swam1.json", function (result) {
        // $.getJSON("../src/map/swam2.json", function (result) {
            $.getJSON("../src/map/fvcomele.json", function (result) {       // 近海水文
                // $.getJSON("../src/map/fvcomuv.json", function (result) {
            for(var i=0;i<result.length;i++){
                geojson.features.push({
                    "type": "Feature",
                    "geometry": {
                        "type": "Point",
                        "coordinates": [result[i].lon,result[i].lat]
                    }
                })
            }

        });*/

        /*$.getJSON("../src/map/lonlat_w9.json", function (result) {
            debugger
            for(var i=0;i<result.length;i++){
                geojson.features.push({
                    "type": "Feature",
                    "geometry": {
                        "type": "Point",
                        "coordinates": [result[i][0],result[i][1]]
                    }
                })
            }
        });*/

        /*let u_lon_imageLonLat=new Float32Array([52.789917,157.18991,0]);
        let u_lat_imageLonLat=new Float32Array([7.29969,59.849686,0]);
        $.getJSON("../src/map/rgbalonlat_w9.json", function (result) {
            debugger
            for(var i=0;i<result.length;i++){
                let currentLonLatRate=[(result[i][0]*256.0+result[i][2])/257.0/255.0,(result[i][1]*256.0+result[i][3])/257.0/255.0];
                let currentLonLat=[currentLonLatRate[0]*(u_lon_imageLonLat[1]-u_lon_imageLonLat[0])+u_lon_imageLonLat[0],currentLonLatRate[1]*(u_lat_imageLonLat[1]-u_lat_imageLonLat[0])+u_lat_imageLonLat[0]];

                geojson.features.push({
                    "type": "Feature",
                    "geometry": {
                        "type": "Point",
                        "coordinates": [currentLonLat[0],currentLonLat[1]]
                    }
                })
            }
        });*/

        for(let i=0;i<l.length;i++){
            geojson.features.push({
                "type": "Feature",
                'properties': {
                    'color': "#000000",
                    "description":l[i][2]
                },
                "geometry": {
                    "type": "Point",
                    "coordinates": [l[i][0],l[i][1]]
                }
            })
        }

        /*// 德洛内
        let ps = Delaunay.triangulate(l);
        let MultiPolygonPs=[];
        // 算直线距离
        /!*let from = turf.point([l[28][0],l[28][1]]);
        let to = turf.point([l[64][0],l[64][1]]);
        let units = "kilometers";
        let maxKm=turf.distance(from, to, {"units":units});*!/
        let maxKm=Math.sqrt(Math.pow(l[64][0]-l[28][0],2)+Math.pow(l[64][1]-l[28][1],2));
        // 除掉距离大于81-44的三角形
        for(let i=0;i<ps.length;i+=3){
            let isValid=true;
            for(let j=0;j<3;j++){
                /!*let from = turf.point([l[ps[i+j%3]][0],l[ps[i+j%3]][1]]);
                let to = turf.point([l[ps[i+(j+1)%3]][0],l[ps[i+(j+1)%3]][1]]);
                let km=turf.distance(from, to, {"units":units});*!/
                let km=Math.sqrt(Math.pow(l[ps[i+(j+1)%3]][0]-l[ps[i+j%3]][0],2)+Math.pow(l[ps[i+(j+1)%3]][1]-l[ps[i+j%3]][1],2));
                if(km>maxKm){
                    isValid=false;
                    break;
                }
            }
            /!*if(isValid){
                MultiPolygonPs.push(...[ps[i],ps[i+1],ps[i+2]]);
            }*!/
            let distance=[];
            for(let j=0;j<3;j++){
                distance.push(Math.sqrt(Math.pow(l[ps[i+(j+1)%3]][0]-l[ps[i+j%3]][0],2)+Math.pow(l[ps[i+(j+1)%3]][1]-l[ps[i+j%3]][1],2)));
            }
            if(Math.min(...distance)/Math.max(...distance)>1/2&&isValid){
                MultiPolygonPs.push(...[ps[i],ps[i+1],ps[i+2]]);
            }
        }
        debugger
        for(let i=0;i<MultiPolygonPs.length;i+=3){
            let currentCoord=[[[[l[MultiPolygonPs[i]][0],l[MultiPolygonPs[i]][1]],[l[MultiPolygonPs[i+1]][0],l[MultiPolygonPs[i+1]][1]],[l[MultiPolygonPs[i+2]][0],l[MultiPolygonPs[i+2]][1]],[l[MultiPolygonPs[i]][0],l[MultiPolygonPs[i]][1]]]]];
            geojsonDelaunay.features.push({
                "type": "Feature",
                'properties': {
                    "group":i/3%3,
                    "name":i,
                    "index":[MultiPolygonPs[i],MultiPolygonPs[i+1],MultiPolygonPs[i+2]]
                },
                "geometry": {
                    "type": "MultiPolygon",
                    "coordinates": currentCoord
                }
            })
        }*/
    });

    map.on("click", function(e) {
        if(group){
            let features = map.queryRenderedFeatures(e.point, { layers: ["delaunary"] });
            if(features.length>0){
                map.setFilter("delaunary", ["==", "group", features[0].properties.group]);
                // map.getSource('delaunary').setData(geojsonDelaunay);
            }
        }else{
            let features = map.queryRenderedFeatures(e.point, { layers: ["delaunary"] });
            if(features.length>0){
                for(var i=0;i<geojsonDelaunay.features.length;i++){
                    if(geojsonDelaunay.features[i].properties.name===features[0].properties.name){
                        geojsonDelaunay.features.splice(i,1);
                        break;
                    }
                }
                map.getSource('delaunary').setData(geojsonDelaunay);
            }
        }
    });

    $("#original").click(function () {
        if(map.getLayer('circle')){
            map.setLayoutProperty('circle', 'visibility', 'visible');
            map.getSource('circle').setData(geojson);
        }else{
            map.addLayer({
                'id': 'circle',
                'type': 'circle',
                "source": {
                    "type": "geojson",
                    "data": geojson
                },
                'layout': {
                    'visibility': 'visible'
                },
                'paint': {
                    "circle-radius": 3,
                    "circle-color": "#e8161c",
                    "circle-opacity": 1
                }
            });
        }

        if(map.getLayer('index')){
            map.setLayoutProperty('index', 'visibility', 'visible');
            map.getSource('index').setData(geojson);
        }else{
            map.addLayer({
                'id': 'index',
                'type': 'symbol',
                "source": {
                    "type": "geojson",
                    "data": geojson
                },
                'layout': {
                    "text-size" : 10,
                    "text-field": "{description}",
                    "text-allow-overlap":true,
                },
                'paint': {
                    "text-color": "#000000"
                }
            });
        }

    });

    $("#delaunay").click(function () {
        if(map.getLayer('delaunary')){
            map.setLayoutProperty('delaunary', 'visibility', 'visible');
            map.getSource('delaunary').setData(geojsonDelaunay);
        }else{
            map.addLayer({
                'id': 'delaunary',
                'type': 'fill',
                "source": {
                    "type": "geojson",
                    "data": geojsonDelaunay
                },
                'layout': {

                },
                'paint': {
                    "fill-color": "#900", /* layer颜色 */
                    "fill-opacity": 0.5      /* layer透明度 */
                }
            });
        }

    });

    $("#export").click(function () {
        let content=[];
        for(var i=0;i<geojsonDelaunay.features.length;i++){
            content.push(...geojsonDelaunay.features[i].properties.index);
        }
        $("#lonlatIndex").val(JSON.stringify(content));
        debugger
        let d = new Float32Array(content);
    });

    $("#import").click(function () {
        // let MultiPolygonPs=JSON.parse($("#lonlatIndex").val());
        let MultiPolygonPs=swa;
        geojsonDelaunay = {
            "type": "FeatureCollection",
            "features": []
        };
        // for(let i=0;i<MultiPolygonPs.length;i+=3){
        for(let i=0;i<Math.floor(MultiPolygonPs.length/3*1/12)*3;i+=3){
        // for(let i=Math.floor(MultiPolygonPs.length/3*1/12)*3;i<Math.floor(MultiPolygonPs.length/3*2/12)*3;i+=3){
        // for(let i=Math.floor(MultiPolygonPs.length/3*2/12)*3;i<Math.floor(MultiPolygonPs.length/3*3/12)*3;i+=3){
        // for(let i=Math.floor(MultiPolygonPs.length/3*3/12)*3;i<Math.floor(MultiPolygonPs.length/3*4/12)*3;i+=3){
        // for(let i=Math.floor(MultiPolygonPs.length/3*4/12)*3;i<Math.floor(MultiPolygonPs.length/3*5/12)*3;i+=3){
        // for(let i=Math.floor(MultiPolygonPs.length/3*5/12)*3;i<Math.floor(MultiPolygonPs.length/3*6/12)*3;i+=3){
        // for(let i=Math.floor(MultiPolygonPs.length/3*6/12)*3;i<Math.floor(MultiPolygonPs.length/3*7/12)*3;i+=3){
        // for(let i=Math.floor(MultiPolygonPs.length/3*7/12)*3;i<Math.floor(MultiPolygonPs.length/3*8/12)*3;i+=3){
        // for(let i=Math.floor(MultiPolygonPs.length/3*8/12)*3;i<Math.floor(MultiPolygonPs.length/3*9/12)*3;i+=3){
        // for(let i=Math.floor(MultiPolygonPs.length/3*9/12)*3;i<Math.floor(MultiPolygonPs.length/3*10/12)*3;i+=3){
        // for(let i=Math.floor(MultiPolygonPs.length/3*10/12)*3;i<Math.floor(MultiPolygonPs.length/3*11/12)*3;i+=3){
        // for(let i=Math.floor(MultiPolygonPs.length/3*11/12)*3;i<MultiPolygonPs.length;i+=3){
            let currentCoord=[[[[l[MultiPolygonPs[i]][0],l[MultiPolygonPs[i]][1]],[l[MultiPolygonPs[i+1]][0],l[MultiPolygonPs[i+1]][1]],[l[MultiPolygonPs[i+2]][0],l[MultiPolygonPs[i+2]][1]],[l[MultiPolygonPs[i]][0],l[MultiPolygonPs[i]][1]]]]];
            geojsonDelaunay.features.push({
                "type": "Feature",
                'properties': {
                    "group":i%300000,
                    "name":i,
                    "index":[MultiPolygonPs[i],MultiPolygonPs[i+1],MultiPolygonPs[i+2]]
                },
                "geometry": {
                    "type": "MultiPolygon",
                    "coordinates": currentCoord
                }
            })
        }
        if(map.getLayer('delaunary')){
            map.setLayoutProperty('delaunary', 'visibility', 'visible');
            map.getSource('delaunary').setData(geojsonDelaunay);
        }else{
            map.addLayer({
                'id': 'delaunary',
                'type': 'fill',
                "source": {
                    "type": "geojson",
                    "data": geojsonDelaunay
                },
                'layout': {

                },
                'paint': {
                    "fill-color": "#900", /* layer颜色 */
                    "fill-opacity": 0.5      /* layer透明度 */
                }
            });
        }
        map.getSource('delaunary').setData(geojsonDelaunay);
    });

    $("#group").click(function () {
        group=!group;
        if(group){
            map.setFilter("delaunary", ["!=", "group", ""]);
        }
    });

</script>
</body>
</html>
