<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset='utf-8' />
    <title></title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src="https://cdn.bootcss.com/jquery/1.10.2/jquery.min.js"></script>
    <script src='//cdn.bootcss.com/mapbox-gl/0.39.1/mapbox-gl.js'></script>
    <link href='//cdn.bootcss.com/mapbox-gl/0.39.1/mapbox-gl.css' rel='stylesheet' />
    <script src='//cdn.bootcss.com/Turf.js/4.5.2/turf.js' charset='utf-8'></script>
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
        .btn-control {
            font:bold 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
            background-color: #3386c0;
            color: #fff;
            position: absolute;
            top: 20px;
            left: 40%;
            border: none;
            width: 200px;
            margin-left:-100px;
            display: block;
            cursor: pointer;
            padding: 10px 20px;
            border-radius: 3px;
        }

        .btn-control:hover {
            background-color: #4ea0da;
        }
        .btn-control1 {
            font:bold 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
            background-color: #3386c0;
            color: #fff;
            position: absolute;
            top: 20px;
            left: 50%;
            border: none;
            width: 200px;
            margin-left:-100px;
            display: block;
            cursor: pointer;
            padding: 10px 20px;
            border-radius: 3px;
        }

        .btn-control1:hover {
            background-color: #4ea0da;
        }
    </style>
</head>
<body>
    <div id='map'></div>
    <button id='filter' class='btn-control'>过滤</button>
    <button id='saveto' class='btn-control1'>加个点</button>
    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoiaGZiNTY0IiwiYSI6ImNqN2I3NnplMTBwb2IzMnJzcWh0OWp6YTQifQ.TM_EQumke3MvFzemeZE48g';
        var map = new mapboxgl.Map({
            container: 'map', // container id
            style: {
                "version": 8,
                "sprite": "mapbox://sprites/mapbox/bright-v8",
                "glyphs": "mapbox://fonts/mapbox/{fontstack}/{range}.pbf",
                "sources": {
                    "raster-tiles": {
                        "type": "raster",
                        "tiles": ['http://mt0.google.cn/vt/v=w2.114&hl=zh-CN&gl=cn&x={x}&y={y}&z={z}'],     //谷歌地图地址
                        "tileSize": 256
                    }
                },
                "layers": [{
                    "id": "simple-tiles",
                    "type": "raster",
                    "source": "raster-tiles",
                    "minzoom": 0,
                    "maxzoom": 22
                }]
            },
            center: [-122.48393028974533, 37.829471820141016], // starting position
            zoom: 15 // starting zoom
        });
        var routes={
            "type": "FeatureCollection",
            "features":[{
                "type":"Feature",
                "properties":{
                    'color': "#E81802"
                },
                "geometry":{
                    "type":"LineString",
                    "coordinates":[]
                }
            }]
        };

        var model={
            "type":"Feature",
            "properties":{
                'color': "#1CE819",
                "name":"Afghanistan"
            },
            "geometry":{
                "type":"LineString",
                "coordinates":[]
            }
        }

        var geojsonLine = {
            "type": "FeatureCollection",
            "features": [{
                "type": "Feature",
                "geometry": {
                    "type": "LineString",
                    "coordinates": []
                }
            }]
        };

        routes.features[0].geometry.coordinates=[[-122.48393028974533, 37.829471820141016],[-122.48395174741744, 37.829412501697064],[-122.4849334359169, 37.829298101706186],[-122.48605459928514, 37.82786596829394]];

        map.on("load", function() {
            map.addSource("LineString", {
                "type": "geojson",
                "data": routes
            });

            map.addLayer({
                "id": "LineString",
                "type": "line",
                "source": "LineString",
                "layout": {
                    "line-join": "round",   /* 线条相交处的样式 */
                    "line-cap": "round"     /* 线条末端的样式 */
                },
                'paint': {
                    'line-width': 3,
                    'line-color': {
                        'type': 'identity',
                        'property': 'color'
                    }
                }
            });

            map.addLayer({
                "id": "state-fills",
                "type": "fill",       /* fill类型layer一般用来表示面 */
                "source": "LineString",
                "layout": {

                },
                "paint": {
                    "fill-color": "#900", /* layer颜色 */
                    "fill-opacity": 1      /* layer透明度 */
                },
                "filter": ["==", "name", ""]
            });
            map.addLayer({
                "id": "state-fills-hover1",
                "type": "circle",
                "source": "LineString",
                "layout": {},
                "paint": {
                    "circle-radius": 10,
                    /*"circle-stroke-width":1 ,
                    "circle-stroke-color":"#e8c305",
                    "circle-stroke-opacity":1,*/
                    "circle-translate":[1,3],
                    "circle-color": "#19ffd0",
                    "circle-opacity":1
                }
            },"state-fills-hover");
            map.addLayer({
                "id": "state-fills-hover",
                "type": "circle",
                "source": "LineString",
                "layout": {},
                "paint": {
                    "circle-radius": 5,
                    /*"circle-stroke-width":1 ,
                    "circle-stroke-color":"#e8c305",
                    "circle-stroke-opacity":1,*/
                    "circle-translate":[1,3],
                    "circle-color": "#1f2dff",
                    "circle-opacity":1
                }
            });



            map.on('mouseenter', 'state-fills-hover1', function(e) {
                /*_map.setPaintProperty('typhoonCircle'+id, "circle-radius",6);*/
                // Change the cursor style as a UI indicator.
                map.getCanvas().style.cursor = 'pointer';


            });

            map.on('mouseleave', 'state-fills-hover', function() {
                map.getCanvas().style.cursor = '';
            });


            /*map.addSource('historicalRouteSource', {
                type: 'geojson',
                data: geojsonLine
            });

            map.addLayer({
                "id": 'historicalRouteQuery',
                "type": "line",
                "source": "historicalRouteSource",
                "paint": {
                    "line-color":'#900',
                    "line-width": 5
                }
            });

            geojsonLine.features[0].geometry.coordinates.push([2,0]);
            geojsonLine.features[0].geometry.coordinates.push([20,20]);
            geojsonLine.features[0].geometry.coordinates.push([20,30]);
            map.getSource('historicalRouteSource').setData(geojsonLine);*/
        });

        $("#filter").click(function(){
            map.setFilter("LineString", ["==", "name", "Afghanistan"]);
            map.setFilter("state-fills-hover", ["==", "name", "Afghanistan"]);
            var geojson = {
                "type": "FeatureCollection",
                "features": []
            };
            geojson.features.push({
                "type": "Feature",
                "properties": {
                    "description": "24 小时警戒线"
                },
                "geometry": {
                    "type": "Point",
                    "coordinates": [127, 34]
                }
            })
            geojson.features.push({
                "type": "Feature",
                "properties": {
                    "description": "48 小时警戒线"
                },
                "geometry": {
                    "type": "Point",
                    "coordinates": [132, 34]
                }
            })
            map.addLayer({
                'id': 'typhoonWarning',
                'type': 'line',
                'source': {
                    'type': 'geojson',
                    'data': {
                        'type': 'FeatureCollection',
                        'features': [{
                            'type': 'Feature',
                            'properties': {
                                'color': "#900",
                                "from":"24小时警戒线"
                            },
                            'geometry': {
                                'type': 'LineString',
                                'coordinates': [
                                    [127, 34],
                                    [127, 22],
                                    [110, 15]
                                ]
                            }
                        }, {
                            'type': 'Feature',
                            'properties': {
                                'color': "#e8c305",
                                "from":"48小时警戒线"
                            },
                            'geometry': {
                                'type': 'LineString',
                                'coordinates': [
                                    [132, 34],
                                    [132, 22],
                                    [125, 15],
                                    [110, 15]
                                ]
                            }
                        }]
                    }
                },
                // The identity function does not take a 'stops' property.
                // Instead, the property value (in this case, 'color') on the source will be the direct output.
                'paint': {
                    'line-width': 2,
                    'line-color': {
                        'type': 'identity',
                        'property': 'color'
                    }
                }
            });


            map.addLayer({
                'id': 'typhoonWarningSymbol',
                'type': 'symbol',
                "source": {
                    "type": "geojson",
                    "data": geojson
                },
                'layout': {
                    'visibility': 'visible',
                    "text-size" : {
                        'base': 15,
                        'stops': [[2,4],[3,10],[4, 15]]
                    },
                    "text-field": "{description}",
                    /*"text-font": ["oss"],*/
                    /*"text-letter-spacing":1,*/
                    "text-max-width":1,
                    "text-offset": [1,5]
                },
                'paint': {
                    "text-color": "red"
                }
            });


        });


        $("#saveto").click(function(){
            /*routes.features[0].geometry.coordinates=[[0,0],[5,50],[5,100],[100,100],[100,0]];*/
            model.geometry.coordinates=[[-122.4833858013153, 37.829607404976734],[-122.48221099376678, 37.82868372835086],[-122.4822163581848, 37.82868372835086],[-122.48205006122589, 37.82801003030873]];
            routes.features.push(model);
            map.getSource('LineString').setData(routes);
        });
    </script>
</body>
</html>
